function CreateReportPDF(e,t){var a=new jsPDF("l","pt",[612,792])
a.setFont("helvetica")
for(var r=(a.internal.pageSize.width/2,["COMPAGNIE","GROUPE","AGENCE","USAGER","QUIZ","DATE DÉBUT","DATE FIN","PROGRÈS","NOTE"]),n=[],o=0;o<e.length;o++){n[o]=[],n[o][0]=e[o][DB_QUIZ_RESULTS_CORPORATE_NAME],n[o][1]=e[o][DB_QUIZ_RESULTS_GROUP_NAME],n[o][2]=e[o][DB_QUIZ_RESULTS_AGENCY_NAME],n[o][3]=e[o][DB_QUIZ_RESULTS_USER_NAME],n[o][4]=e[o][DB_QUIZ_RESULTS_QUIZ_NAME],n[o][5]=e[o][DB_QUIZ_RESULTS_START_DATE],n[o][6]=e[o][DB_QUIZ_RESULTS_END_DATE],n[o][7]=e[o][DB_QUIZ_RESULTS_PROGRESS_NAME]
var _="N/A"
if(""!=e[o][DB_QUIZ_RESULTS_QUIZ_SCORE]){var s=GetUserScorePerSection(e[o][DB_QUIZ_RESULTS_QUIZ_SCORE]),i=GetUserGlobalScore(s)
_=parseInt(i)+" %"}n[o][8]=_}var l=0,a=new jsPDF("l","pt")
a.PrintPageHeader("Gestion des quiz","État de la progression"),a.autoTable(r,n,{styles:{fontSize:8},startY:100,afterPageContent:function(e){l++}})
for(var o=1;l>=o;o++)a.setPage(o),a.PrintPageFooter(o,l,-1)
a.save("User_Participation.pdf")}function CreatePDF(e,t,a){options_data_array=JSON.parse(t),OPTION_Radar_graph=options_data_array[PDF_GEN_OPTION_SHOW_GRAPH]?!0:!1,OPTION_Show_Questions=options_data_array[PDF_GEN_OPTION_SHOW_ANSWERS]?!0:!1,OPTION_COMPARE_TO=options_data_array[PDF_GEN_OPTION_USER_REPORT_COMPARE],OPTION_SEPERATE_PDF=options_data_array[PDF_GEN_OPTION_SEPERATE_PDF]?!0:!1,OPTION_Show_Answers_Scores=options_data_array[PDF_GEN_OPTION_SHOW_ANSWERS_SCORES]?!0:!1,OPTION_Show_Best_Answers=options_data_array[PDF_GEN_OPTION_SHOW_BEST_ANSWERS]?!0:!1,$.ajax({url:"../php/nova_api_get_averages.php",type:"post",async:!0,headers:{"cache-control":"no-cache"},cache:!1,data:JSON.stringify({data:e,data2:OPTION_COMPARE_TO}),dataType:"text",success:function(r){return"QUERY_ERROR"==r||"DB_OPEN_ERROR"==r||"DB_READ_ERROR"==r?void alert("ERREUR: lecture de la base de données impossible..."):void PrePDFCreation(e,t,a,r)},error:function(e,t,a){alert("ERREUR: lecture de la base de données impossible...")}})}function CreateUserPDF(e,t,a){OPTION_COMPARE_TO="none",$.ajax({url:"../../php/nova_api_get_averages.php",type:"post",async:!0,headers:{"cache-control":"no-cache"},cache:!1,data:JSON.stringify({data:e,data2:OPTION_COMPARE_TO}),dataType:"text",success:function(r){return"QUERY_ERROR"==r||"DB_OPEN_ERROR"==r||"DB_READ_ERROR"==r?void alert("ERREUR: lecture de la base de données impossible..."):void PrePDFCreation(e,t,a,r)},error:function(e,t,a){alert("ERREUR: lecture de la base de données impossible...")}})}function GetSectionTitlesFromQuiz(e){for(var t=[],a=0;a<e.section.length;a++)t.push(e.section[a].sectionTitle)
return t}function GetUserScorePerSection(e){for(var t=[],a=e.split(","),r=0;r<a.length;r++){var n=a[r].substring(a[r].lastIndexOf("r")+1,a[r].lastIndexOf("m")),o=a[r].substring(a[r].lastIndexOf("m")+1),_=+(0>n?0:n)/+o*100
t.push(_)}return t}function GetUserGlobalScore(e){for(var t=0,a=0;a<e.length;a++)t+=e[a]
return t/e.length}function FindUserFirstResults(e,t,a){for(var r=-1,n=-1,o=0;o<a.length;o++)a[o].USER_ID==e&&a[o].QUIZ_ID==t&&(r=a[o].QUIZ_GROUP_ID,n=a[o].QUIZ_ORDER)
var _=[]
if(1==n||-1==n)return _
for(var o=0;o<a.length;o++)a[o].USER_ID==e&&a[o].QUIZ_GROUP_ID==r&&1==a[o].QUIZ_ORDER&&(_=a[o])
return _}function GetAveragesDataFromAveragesArray(e){for(var t=[],a=0;a<e.length;a++){var r=+(e[a][0]<0?0:e[a][0])/+e[a][1]*100
t.push(r)}return t}function GetCurrentCompleteDate(){var e=new Date,t=e.getDate(),a=e.getMonth()+1,r=e.getFullYear()
10>t&&(t="0"+t),10>a&&(a="0"+a)
var e=t+"/"+a+"/"+r
return e}function CreateStar(e,t,a,r,n,o){var _,s,l=Math.PI/2*3,c=t,S=a,d=Math.PI/r,g=.8*n,h=.4*n
for(e.setLineWidth(o),_=t,s=a-g,i=0;i<r;i++)c=t+Math.cos(l)*g,S=a+Math.sin(l)*g,e.line(_,s,c,S),l+=d,_=t+Math.cos(l)*h,s=a+Math.sin(l)*h,e.line(c,S,_,s),l+=d
e.line(_,s,t,a-g),e.circle(t,a,n)}function PrePDFCreation(e,t,a,r){PDF_Nb_Pages=1,PDF_Nb_Pages_Per_User=[]
var n=new jsPDF("p","pt","a4")
n.setFont("helvetica"),n.setLineWidth(1),json_data_array=JSON.parse(e),quiz_data_array=JSON.parse(a),offscreenCanvas=document.createElement("canvas"),offscreenCanvas.width=800,offscreenCanvas.height=800
var o=offscreenCanvas.getContext("2d")
Chart.plugins.register({beforeDraw:function(e){var t=e.chart.ctx
t.fillStyle="white",t.fillRect(0,0,e.chart.width,e.chart.height)}})
for(var _=0;_<json_data_array.length;_++){progress_cur_element=_,progress_message="Création donnée #"+_+" de "+json_data_array.length+" ..."
for(var s=-1,i=0;i<quiz_data_array.length;i++)quiz_data_array[i][DB_QUIZ_DATA_QUIZ_ID]==json_data_array[_][DB_QUIZ_RESULTS_QUIZ_ID]&&(s=i)
if(-1==s)return void alert("ERREUR: impossible de trouver les données du quiz: "+json_data_array[_][DB_QUIZ_RESULTS_QUIZ_ID])
JSON_content=JSON.parse(quiz_data_array[s][DB_QUIZ_DATA_QUIZ_DATA])
var l=GetSectionTitlesFromQuiz(JSON_content),c=GetUserScorePerSection(json_data_array[_][DB_QUIZ_RESULTS_QUIZ_SCORE])
user_global_score=GetUserGlobalScore(c)
var S,d,g="",h="",I=JSON.parse(r)
if("none"==OPTION_COMPARE_TO)S=FindUserFirstResults(json_data_array[_][DB_QUIZ_RESULTS_USER_ID],json_data_array[_][DB_QUIZ_RESULTS_QUIZ_ID],I),void 0!==S.USER_ID&&(d=GetUserScorePerSection(S.QUIZ_SCORE),comparaison_global_score=GetUserGlobalScore(d),g="Comparaison '"+json_data_array[_][DB_QUIZ_RESULTS_QUIZ_NAME]+"' avec '"+S.QUIZ_NAME+"'",h=S.QUIZ_NAME)
else if("CORPORATES"==OPTION_COMPARE_TO){for(var p=[],i=0;i<I.length;i++)I[i][1]==json_data_array[i][DB_QUIZ_RESULTS_QUIZ_ID]&&I[i][2]==json_data_array[i][DB_QUIZ_RESULTS_CORPORATE_ID]&&(p=I[i][3])
d=GetAveragesDataFromAveragesArray(p),comparaison_global_score=GetUserGlobalScore(d),g="Comparaison avec la moyenne de la compagnie ("+GetCurrentCompleteDate()+")",h="Moyenne compagnie"}else if("GROUPS"==OPTION_COMPARE_TO){for(var O=[],i=0;i<I.length;i++)I[i][1]==json_data_array[i][DB_QUIZ_RESULTS_QUIZ_ID]&&I[i][2]==json_data_array[i][DB_QUIZ_RESULTS_GROUP_ID]&&(O=I[i][3])
d=GetAveragesDataFromAveragesArray(O),comparaison_global_score=GetUserGlobalScore(d),g="Comparaison avec la moyenne du groupe ("+GetCurrentCompleteDate()+")",h="Moyenne groupe"}else if("AGENCIES"==OPTION_COMPARE_TO){for(var T=[],i=0;i<I.length;i++)I[i][1]==json_data_array[i][DB_QUIZ_RESULTS_QUIZ_ID]&&I[i][2]==json_data_array[i][DB_QUIZ_RESULTS_AGENCY_ID]&&(T=I[i][3])
d=GetAveragesDataFromAveragesArray(T),comparaison_global_score=GetUserGlobalScore(d),g="Comparaison avec la moyenne de l'agence ("+GetCurrentCompleteDate()+")",h="Moyenne agence"}Chart.defaults.global.defaultFontStyle="bold",Chart.defaults.global.defaultFontSize=16,""!=g?(chartjs_config_comparison.data.datasets[0].data=c,chartjs_config_comparison.data.datasets[0].label=json_data_array[_][DB_QUIZ_RESULTS_QUIZ_NAME],chartjs_config_comparison.data.labels=l,chartjs_config_comparison.data.datasets[1].data=d,chartjs_config_comparison.data.datasets[1].label=h,chartjs_config_comparison.options.title.text=g,currentChart=new Chart.Radar(o,chartjs_config_comparison)):(chartjs_config.data.datasets[0].data=c,chartjs_config.data.datasets[0].label=json_data_array[_][DB_QUIZ_RESULTS_QUIZ_NAME],chartjs_config.data.labels=l,currentChart=new Chart.Radar(o,chartjs_config)),chart_area_img=offscreenCanvas.toDataURL("image/jpeg",1),n=GeneratePDF(n,_),_<json_data_array.length-1&&(n.addPage(),PDF_Nb_Pages++),user_global_score=-1,comparaison_global_score=-1}for(var U=1,_=0;_<json_data_array.length;_++)for(var E=0;E<PDF_Nb_Pages_Per_User[_];E++)n.setPage(U),n.PrintPageFooter(U,PDF_Nb_Pages,_),U++
n.save("User_Report.pdf")}function FindBestAnswerIndex(e){return e.indexOf(Math.max.apply(null,e))}function GetCurrentQuestionGoodAnswerArray(e){for(var t="",a=0;a<quiz_data_array.length;a++)quiz_data_array[a][DB_QUIZ_DATA_QUIZ_ID]==e&&(t=quiz_data_array[a][DB_QUIZ_DATA_ANSWER_JSON])
if(""==t)return IMG_unchecked
for(var r=[],n=t.split("|"),o=0;o<n.length;o++){r[o]=[]
for(var _=n[o].split(";"),s=0;s<_.length;s++){r[o][s]=[]
for(var i=_[s].split(",").map(Number),l=0;l<i.length;l++)r[o][s][l]=i[l]}}return r}function GetTextQuestionScore(e,t,a,r){var n=GetCurrentQuestionGoodAnswerArray(r),o=n[t][a],_=o.indexOf(Math.max.apply(null,o))
return parseInt(o[e])+" / "+parseInt(o[_])}function GetImageForQuestionAnswer(e,t,a,r,n){var o=GetCurrentQuestionGoodAnswerArray(n),_=o[t][a],s=_.indexOf(Math.max.apply(null,_))
return OPTION_Show_Best_Answers?r!=e&&r!=s?IMG_unchecked:r==e&&r==s?IMG_Good_Asnwer:r==e&&r!=s?IMG_Wrong_Answer:r!=e&&r==s?IMG_Best_Answer:void 0:r!=e?IMG_unchecked:IMG_Best_Answer}function GeneratePDF(e,t){previousData=sortSelectedAnswers(json_data_array[t][DB_QUIZ_RESULTS_ANSWERS])
var a=0,r=1,n=2,o=3,_=4,s=0,i=1,l=0,c=2,S=JSON_content.pageTitle,d=[],g=te=se=0
for(g=0;g<JSON_content.section.length;g++){var h=[]
h.push([]),h[0]=JSON_content.section[g].sectionTitle,h[1]=JSON_content.section[g].color.red,h[2]=JSON_content.section[g].color.green,h[3]=JSON_content.section[g].color.blue
var I=[]
for(te=0;te<JSON_content.section[g].question.length;te++){I.push([]),I[te][0]=JSON_content.section[g].question[te].questionTitle
var p=[]
for(se=0;se<JSON_content.section[g].question[te].answer.length;se++)p.push([]),p[se][0]=JSON_content.section[g].question[te].answer[se].answerText,p[se][1]=JSON_content.section[g].question[te].answer[se].weight
I[te].push(p),h[4]=I}d.push(h)}var O,T=1
if(O=OPTION_Show_Questions?Math.ceil(d.length/c):0,OPTION_Radar_graph){if(IMG_Chart.src=chart_area_img,e.addImage(IMG_Chart,"JPEG",47.5,150,500,500),O+=1,e.setFontSize(10),e.setFontType("normal"),e.setTextColor(0),e.PrintPageHeader(S,"Résumé des résultats"),e.setFontSize(10),e.setFontType("normal"),e.setTextColor(0),e.CenterText("Note globale: "+parseInt(user_global_score,10)+" %",670),-1!=comparaison_global_score){var U=""
"none"==OPTION_COMPARE_TO&&(U="Ancienne note: "),"CORPORATES"==OPTION_COMPARE_TO&&(U="Moyenne compagnie: "),"GROUPS"==OPTION_COMPARE_TO&&(U="Moyenne groupe: "),"AGENCIES"==OPTION_COMPARE_TO&&(U="Moyenne agence: "),e.CenterText(U+parseInt(comparaison_global_score,10)+" %",685)}OPTION_Show_Questions&&(e.addPage(),T++,PDF_Nb_Pages++)}if(OPTION_Show_Questions)for(var E=40,D=22,u=20,R=100,P=12,A=80,f=410,N=30,C=430,F=10,v=8,y=3,Q=-13,m=5,b=10,G=2,Z=40,B=15,M=159,x=202,w=143,j=14,z=8,L=12,W=10,J=10,q=0,k=0,H=0,Y=0,$=0,K=R,g=0;g<d.length;g++){var V=0
e.setFontSize(12)
for(var X=K+e.internal.getFontSize(),ee=0,te=0;te<d[g][_].length;te++){var ae=0
e.setFontType("bold"),e.setTextColor(0),e.setFontSize(L)
var re=e.splitTextToSize(d[g][_][te][s],f)
e.text(u+A,X+V,re)
var ne=e.internal.getFontSize()*re.length
OPTION_Show_Answers_Scores&&(e.setFillColor(M,x,w),e.rect(u+A+f+G,X+V-e.internal.getFontSize()+3,Z,B,"F"),e.setFontSize(J),e.setFontType("bold"),e.setTextColor(255),e.CenterTextInRect(GetTextQuestionScore(previousData["section"+g]["question"+te].answer,g,te,json_data_array[t][DB_QUIZ_RESULTS_QUIZ_ID]),"horizontal",u+A+f+G,X+V-e.internal.getFontSize()+3,Z,B-3))
for(var oe=ne+F,_e=0,se=0;se<d[g][_][te][i].length;se++)re=[],e.setFontType("normal"),e.setTextColor(0),e.setFontSize(W),re=e.splitTextToSize(d[g][_][te][i][se][l],C),e.addImage(GetImageForQuestionAnswer(previousData["section"+g]["question"+te].answer,g,te,se,json_data_array[t][DB_QUIZ_RESULTS_QUIZ_ID]),"jpg",u+A+y,X+Q+oe+V,18,18),e.text(u+A+N,X+oe+V,re),oe+=v+e.internal.getFontSize()*re.length,_e+=v+e.internal.getFontSize()*re.length
ae=_e+ne+F,e.setFontSize(L),e.setFillColor(parseInt(d[g][r]),parseInt(d[g][n]),parseInt(d[g][o])),q=u+E+P-m,k=X-e.internal.getFontSize()+V,Y=D,H=ae+m,e.rect(q,k,Y,H,"F"),$=X-e.internal.getFontSize()+V+ae+m,ee+=ae+m,e.setFontType("bold"),e.setTextColor(255),e.setFontSize(z),e.CenterTextInRect("Question "+(te+1),"vertical",q,k,Y,H),V+=P+_e+ne+F}e.setTextColor(255),e.setFontSize(j),e.setFontType("bold"),e.setFillColor(parseInt(d[g][r]),parseInt(d[g][n]),parseInt(d[g][o])),q=u,k=K,Y=E,H=$-K,e.rect(q,k,Y,H,"F"),e.CenterTextInRect(d[g][a],"vertical",q,k,Y,H),e.setFontSize(10),e.setFontType("normal"),e.setTextColor(0),e.PrintPageHeader(S,"Réponses aux questions"),g<d.length-1&&((g+1)%c==0?(e.addPage(),T++,PDF_Nb_Pages++,K=R):K=k+H+b)}return PDF_Nb_Pages_Per_User.push(O),e}var JSON_content,IMG_unchecked=new Image,IMG_Good_Asnwer=new Image,IMG_Best_Answer=new Image,IMG_Wrong_Answer=new Image,IMG_Chart=new Image,OPTION_Radar_graph=!0,OPTION_Show_Questions=!0,OPTION_Show_Answers_Scores=!0,OPTION_Show_Best_Answers=!0,OPTION_COMPARE_TO="",OPTION_SEPERATE_PDF=!1,json_data_array,options_data_array,quiz_data_array,chartjs_config,chartjs_config_comparison,DB_QUIZ_DATA_QUIZ_ID=0,DB_QUIZ_DATA_QUIZ_NAME=1,DB_QUIZ_DATA_START_DATE=2,DB_QUIZ_DATA_END_DATE=3,DB_QUIZ_DATA_LOCKED_ON_COMPLETION=4,DB_QUIZ_DATA_TIME_TO_COMPLETE=5,DB_QUIZ_DATA_QUIZ_DATA=6,DB_QUIZ_DATA_IS_USER_CAN_DISPLAY_CHART=7,DB_QUIZ_DATA_IS_USER_CAN_DISPLAY_QA=8,DB_QUIZ_DATA_IS_ENABLED=9,DB_QUIZ_DATA_IS_USER_SEE_GOOD_ANSWER=10,DB_QUIZ_DATA_ANSWER_JSON=11,chartColors=window.chartColors,color=Chart.helpers.color,PDF_Nb_Pages=1,PDF_Nb_Pages_Per_User=[],progress_message="",progress_update_delay=500,progress_cur_element=0,user_global_score=-1,comparaison_global_score=-1
chartjs_config={data:{datasets:[{pointBorderColor:"rgba(0,0,0,1)",pointBackgroundColor:"rgba(255,0,0,1)",strokeWidth:10,pointRadius:5,data:[],backgroundColor:[color(chartColors.red).alpha(.5).rgbString()],label:"Mon pointage"}],labels:[]},options:{scaleFontStyle:"bold",scaleFontSize:14,pointDot:!0,responsive:!1,legend:{position:"bottom"},title:{display:!0,text:""},scale:{ticks:{display:!0,beginAtZero:!0,max:100,min:0},pointLabels:{fontSize:14},elements:{point:{radius:10}},gridLines:{color:"rgba(0, 0, 0, 0.5)",lineWidth:1},reverse:!1},animation:!1}},chartjs_config_comparison={data:{datasets:[{pointBorderColor:"rgba(0,0,0,1)",pointBackgroundColor:"rgba(255,0,0,1)",strokeWidth:10,pointRadius:5,data:[],backgroundColor:[color(chartColors.red).alpha(.5).rgbString()],label:""},{pointBorderColor:"rgba(0,0,0,1)",pointBackgroundColor:"rgba(0,0,255,1)",strokeWidth:10,pointRadius:5,data:[],backgroundColor:[color(chartColors.blue).alpha(.5).rgbString()],label:""}],labels:[]},options:{scaleFontStyle:"bold",scaleFontSize:14,pointDot:!0,responsive:!1,legend:{position:"bottom"},title:{display:!0,text:""},scale:{ticks:{display:!0,beginAtZero:!0,max:100,min:0},pointLabels:{fontSize:14},elements:{point:{radius:10}},gridLines:{color:"rgba(0, 0, 0, 0.5)",lineWidth:1},reverse:!1},animation:!1}},function(e){e.CenterText=function(e,t){var a=this.internal.getFontSize(),r=this.internal.pageSize.width
txtWidth=this.getStringUnitWidth(e)*a/this.internal.scaleFactor,x=(r-txtWidth)/2,this.text(e,x,t)}}(jsPDF.API),function(e){e.CenterTextInRect=function(e,t,a,r,n,o){if(t=t||{},"horizontal"==t){var _=this.internal.getFontSize(),s=this.getStringUnitWidth(e)*_/this.internal.scaleFactor,i=this.getTextDimensions(e)
rect_x=(n-s)/2,rect_y=(o+i.h/2)/2,this.text(e,a+rect_x,r+rect_y)}if("vertical"==t){var _=this.internal.getFontSize(),s=this.getTextWidth(e),i=this.getTextDimensions(e)
rect_x=n/2+i.h/3,rect_y=o/2+s/2,this.text(a+rect_x,r+rect_y,e,null,90)}}}(jsPDF.API),function(e){e.PrintPageFooter=function(e,t,a){this.setLineWidth(.1),this.setDrawColor(0,0,0),this.line(20,this.internal.pageSize.height-32,this.internal.pageSize.width-20,this.internal.pageSize.height-32),this.setFontSize(8),this.setFontType("normal"),this.textEx("Page "+e+" de "+t,this.internal.pageSize.width-20,this.internal.pageSize.height-17,"right","bottom"),-1!=a&&this.text(20,this.internal.pageSize.height-17,json_data_array[a][DB_QUIZ_RESULTS_CORPORATE_NAME]+" / "+json_data_array[a][DB_QUIZ_RESULTS_GROUP_NAME]+" / "+json_data_array[a][DB_QUIZ_RESULTS_AGENCY_NAME]+" / "+json_data_array[a][DB_QUIZ_RESULTS_USER_NAME]+" / "+json_data_array[a][DB_QUIZ_RESULTS_QUIZ_NAME]+" ("+json_data_array[a][DB_QUIZ_RESULTS_END_DATE]+")")}}(jsPDF.API),function(e){e.PrintPageHeader=function(e,t){this.setLineWidth(.1),this.setDrawColor(0,0,0),this.setFontType("bold"),this.setFontSize(16),this.CenterText(e,50),this.setFontType("normal"),this.setFontSize(12),this.CenterText(t,70),this.line(20,90,this.internal.pageSize.width-20,90)}}(jsPDF.API)
var splitRegex=/\r\n|\r|\n/g
!function(e){e.textEx=function(e,t,a,r,n){var o=this.internal.getFontSize()/this.internal.scaleFactor,_=1.15,s=null,i=1
if(("middle"===n||"bottom"===n||"center"===r||"right"===r)&&(s="string"==typeof e?e.split(splitRegex):e,i=s.length||1),a+=o*(2-_),"middle"===n?a-=i/2*o:"bottom"===n&&(a-=i*o),"center"===r||"right"===r){var l=o
if("center"===r&&(l*=.5),i>1){for(var c=0;c<s.length;c++)this.text(s[c],t-this.getStringUnitWidth(s[c])*l,a),a+=o
return this}t-=this.getStringUnitWidth(e)*l}return this.text(e,t,a),this}}(jsPDF.API),IMG_Good_Asnwer.src=baseUrl+"/media/assets/Good_answer.jpg",IMG_unchecked.src=baseUrl+"/media/assets/Unchecked.jpg",IMG_Best_Answer.src=baseUrl+"/media/assets/Best_answer.jpg",IMG_Wrong_Answer.src=baseUrl+"/media/assets/Wrong_answer.jpg"
